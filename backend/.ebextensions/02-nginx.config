files:
  "/opt/elasticbeanstalk/tasks/nginx/nginx.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      # This file is a placeholder - actual nginx config is modified via container commands

container_commands:
  01_add_nginx_body_size:
    command: |
      # Find and modify the nginx server block to add client_max_body_size
      # This works for Elastic Beanstalk Java platforms
      if [ -f /etc/nginx/conf.d/elasticbeanstalk-nginx.conf ]; then
        # Backup original
        cp /etc/nginx/conf.d/elasticbeanstalk-nginx.conf /etc/nginx/conf.d/elasticbeanstalk-nginx.conf.bak
        
        # Check if client_max_body_size already exists
        if ! grep -q "client_max_body_size" /etc/nginx/conf.d/elasticbeanstalk-nginx.conf; then
          # Add client_max_body_size after the server_name line or at the start of server block
          sed -i '/server_name/a\    client_max_body_size 100M;' /etc/nginx/conf.d/elasticbeanstalk-nginx.conf
          sed -i '/client_max_body_size/a\    client_body_buffer_size 128k;' /etc/nginx/conf.d/elasticbeanstalk-nginx.conf
          sed -i '/client_body_buffer_size/a\    client_body_timeout 300s;' /etc/nginx/conf.d/elasticbeanstalk-nginx.conf
          sed -i '/client_body_timeout/a\    proxy_connect_timeout 300s;' /etc/nginx/conf.d/elasticbeanstalk-nginx.conf
          sed -i '/proxy_connect_timeout/a\    proxy_send_timeout 300s;' /etc/nginx/conf.d/elasticbeanstalk-nginx.conf
          sed -i '/proxy_send_timeout/a\    proxy_read_timeout 300s;' /etc/nginx/conf.d/elasticbeanstalk-nginx.conf
        fi
      fi
      
      # Also create/update proxy.conf as backup method
      cat > /etc/nginx/conf.d/proxy.conf << 'EOF'
      # Increase client body size limit to 100MB (to handle video uploads up to 75MB with buffer)
      client_max_body_size 100M;
      
      # Increase buffer sizes for large uploads
      client_body_buffer_size 128k;
      client_header_buffer_size 1k;
      large_client_header_buffers 4 16k;
      
      # Timeout settings for large uploads
      client_body_timeout 300s;
      client_header_timeout 300s;
      send_timeout 300s;
      
      # Proxy settings
      proxy_connect_timeout 300s;
      proxy_send_timeout 300s;
      proxy_read_timeout 300s;
      EOF
      
      # Test nginx configuration
      nginx -t || true
    ignoreErrors: true

